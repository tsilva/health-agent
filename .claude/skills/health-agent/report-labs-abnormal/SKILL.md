---
name: report-labs-abnormal
description: Generate out-of-range lab values section with severity and trends. Use when user asks "generate labs report", "abnormal labs for doctor", "lab results summary for provider", or needs a saveable document of concerning lab values.
---

# Report: Abnormal Labs

Generate a standardized section documenting out-of-range lab values with context and trends.

## Purpose

This report section provides:
- Critical values requiring immediate attention
- Abnormal values outside reference ranges
- Borderline values approaching limits
- Trend indicators showing direction of change

## Workflow

1. Load profile and extract `labs_path` and demographics
2. Check if `{labs_path}/lab_specs.json` exists for canonical names and units
3. Extract abnormal values from all.csv using efficient filters
4. Classify by severity (Critical, Abnormal, Borderline)
5. Calculate trend indicators by comparing historical values
6. Apply age/gender context from demographics
7. Format into standardized section using canonical names when available
8. Save to `.output/{profile}/sections/labs-abnormal-{date}.md`

## Efficient Data Access

### Extract Abnormal Values
```bash
head -1 "{labs_path}/all.csv" && grep -E ",True," "{labs_path}/all.csv"
```

### Recent Abnormal Values (Last 12 Months)
```bash
head -1 "{labs_path}/all.csv" && grep "^202[56]-" "{labs_path}/all.csv" | grep -E ",True,"
```

### Get History for Trend Calculation

**With lab_specs.json** (more accurate):
```bash
# Source helper functions
source .claude/skills/health-agent/references/lab-specs-helpers.sh

# Build pattern for marker and get canonical name
if has_lab_specs "{labs_path}/lab_specs.json"; then
    pattern=$(build_grep_pattern "{labs_path}/lab_specs.json" "{marker_name}")
    canonical=$(get_canonical_name "{labs_path}/lab_specs.json" "{marker_name}")
    if [ -n "$pattern" ]; then
        head -1 "{labs_path}/all.csv" && grep -iE "$pattern" "{labs_path}/all.csv" | sort -t',' -k1
    else
        head -1 "{labs_path}/all.csv" && grep -i "{marker_name}" "{labs_path}/all.csv" | sort -t',' -k1
    fi
else
    head -1 "{labs_path}/all.csv" && grep -i "{marker_name}" "{labs_path}/all.csv" | sort -t',' -k1
fi
```

**Without lab_specs.json** (fallback):
```bash
head -1 "{labs_path}/all.csv" && grep -i "{marker_name}" "{labs_path}/all.csv" | sort -t',' -k1
```

### Display Canonical Names in Report

When lab_specs.json exists, use canonical names for consistency:
```bash
# Get canonical name and primary unit
canonical=$(get_canonical_name "{labs_path}/lab_specs.json" "{raw_marker_name}")
unit=$(get_primary_unit "{labs_path}/lab_specs.json" "{raw_marker_name}")

# Display as: "{canonical}" instead of raw lab_name from CSV
# This ensures "A1C", "HbA1c", "Hemoglobin A1c" all appear as "HbA1c" (canonical name)
```

## Severity Classification

### Critical (Immediate Attention)
- Values in critical ranges (e.g., potassium <2.5 or >6.0, glucose <40)
- Values >2x deviation from reference boundary

### Abnormal (High/Low)
- Outside reference range but not critical
- Use `is_above_limit` or `is_below_limit` columns

### Borderline (Monitor)
- Within 10% of reference range boundary
- Calculate: `(value - boundary) / boundary <= 0.10`

## Trend Indicators

Compare current value to previous values for the same marker:

| Indicator | Meaning |
|-----------|---------|
| ↑ | Increasing (worse if already high) |
| ↓ | Decreasing (worse if already low) |
| → | Stable (no significant change) |
| ↑↑ | Rapidly increasing (>20% change) |
| ↓↓ | Rapidly decreasing (>20% change) |
| NEW | First occurrence of this marker |

## Output Format

The section must follow this exact format for composability:

```markdown
---
section: labs-abnormal
generated: {YYYY-MM-DD}
demographics: {age}yo {gender}
---

# Abnormal Lab Values

## Critical Values

| Date | Marker | Value | Reference | Status | Trend |
|------|--------|-------|-----------|--------|-------|
| {date} | {marker} | {value} {unit} | {ref_min}-{ref_max} | CRITICAL HIGH/LOW | {trend} |

*No critical values* (if none)

## Abnormal Values

| Date | Marker | Value | Reference | Status | Trend |
|------|--------|-------|-----------|--------|-------|
| {date} | {marker} | {value} {unit} | {ref_min}-{ref_max} | HIGH/LOW | {trend} |

## Borderline Values

| Date | Marker | Value | Reference | Status | Trend |
|------|--------|-------|-----------|--------|-------|
| {date} | {marker} | {value} {unit} | {ref_min}-{ref_max} | Borderline | {trend} |

## Persistent Abnormalities

Markers abnormal on 2+ occasions:

- **{marker}**: {status} on {date1}, {date2}, {date3}

---
*Section generated by health-agent report-labs-abnormal skill*
```

## Output File

- **Directory**: `.output/{profile}/sections/`
- **Filename**: `labs-abnormal-YYYY-MM-DD.md`
- **Create directory if needed**: `mkdir -p .output/{profile}/sections`

## Section Header Requirements

For composability with other report sections:
1. Include YAML frontmatter with section name, date, and demographics
2. Use consistent H1 header format
3. End with horizontal rule and attribution line
4. Include "No critical values" note if the section would otherwise be empty

## Demographics Context

Use profile's `date_of_birth` and `gender` to:
1. Calculate current age
2. Apply age-specific adjustments (reference ranges vary by age for some markers)
3. Apply gender-specific ranges (reference ranges vary by gender for some markers)
4. Note adjusted ranges in output when used

## Reference Range Handling

Parse various formats:
- "70-100" → min=70, max=100
- "<100" → max=100, no min
- ">50" → min=50, no max
- Strip units from range strings

## Special Considerations

- **Low Confidence**: Flag values with confidence <0.8 for verification
- **Recent Tests**: Prioritize values from last 6 months
- **Context Notes**: Add brief clinical context for critical values
